// Generated by CoffeeScript 1.4.0

/*
Background Page Main JavaScript
*/


(function() {

  $(function() {
    return BackgroundApplication.get_auth_data(function(items) {
      var auth_string, subdomain;
      subdomain = items.harvest_subdomain;
      auth_string = items.harvest_auth_string;
      if (subdomain && auth_string) {
        window.application = new BackgroundApplication(subdomain, auth_string);
        setTimeout(window.application.refresh_hours, 500);
        return window.application.start_refresh_interval();
      } else {
        if (localStorage['harvest_subdomain'] && localStorage['harvest_auth_string']) {
          console.log("Migrating preferences from localStorage to chrome.storage.local");
          return BackgroundApplication.migrate_preferences(function(items) {
            window.application = new BackgroundApplication(items.harvest_subdomain, items.harvest_auth_string);
            setTimeout(window.application.refresh_hours, 500);
            return window.application.start_refresh_interval();
          });
        } else {
          window.application = new BackgroundApplication(false, false);
          chrome.browserAction.setBadgeText({
            text: '!'
          });
          return console.error('Error initializing Hayfever. Please visit the options page.');
        }
      }
    });
  });

}).call(this);
