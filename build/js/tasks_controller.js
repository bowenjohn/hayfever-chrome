// Generated by CoffeeScript 1.6.3
/*
Angular.js Popup Tasks Controller
*/


(function() {
  var app, clock_time_filter, tasks_controller;

  app = angular.module('hayfeverApp', ['ui']);

  tasks_controller = function($scope) {
    var bg_app, bg_page;
    bg_page = chrome.extension.getBackgroundPage();
    bg_app = bg_page.application;
    $scope.form_visible = false;
    $scope.runaway_timer = false;
    $scope.harvest_url = bg_app.client.subdomain ? bg_app.client.full_url : null;
    $scope.authorized = bg_app.authorized;
    $scope.projects = bg_app.projects;
    $scope.timers = bg_app.todays_entries;
    $scope.prefs = bg_app.preferences;
    $scope.current_hours = bg_app.current_hours;
    $scope.total_hours = bg_app.total_hours;
    $scope.current_task = bg_app.current_task;
    $scope.active_timer_id = 0;
    $scope.tasks = [];
    $scope.form_task = {
      project: null,
      task: null,
      hours: null,
      notes: null
    };
    $scope.refresh = function() {
      return bg_app.refresh_hours(function() {
        $scope.harvest_url = bg_app.client.subdomain ? bg_app.client.full_url : null;
        $scope.authorized = bg_app.authorized;
        $scope.projects = bg_app.projects;
        $scope.clients = bg_app.clients;
        $scope.timers = bg_app.todays_entries;
        $scope.current_hours = bg_app.current_hours;
        $scope.total_hours = bg_app.total_hours;
        $scope.current_task = bg_app.current_task;
        bg_app.get_preferences(function() {
          $scope.prefs = bg_app.preferences;
          return $scope.$apply();
        });
        return $scope.$apply();
      });
    };
    $scope.add_timer = function() {
      var result, task;
      task = {
        project_id: $scope.form_task.project,
        task_id: $scope.form_task.task,
        hours: $scope.form_task.hours,
        notes: $scope.form_task.notes
      };
      result = $scope.active_timer_id !== 0 ? bg_app.client.update_entry($scope.active_timer_id, task) : bg_app.client.add_entry(task);
      return result.success(function(json) {
        $scope.hide_form();
        return $scope.refresh();
      });
    };
    $scope.project_change = function() {
      var current_project, tasks;
      $scope.tasks = [];
      current_project = _(bg_app.projects).find(function(p) {
        return p.id === parseInt($scope.form_task.project);
      });
      tasks = current_project.tasks;
      return tasks.forEach(function(task) {
        task.billable_text = task.billable ? 'Billable' : 'Non Billable';
        return $scope.tasks.push(task);
      });
    };
    $scope.toggle_timer = function(timer_id) {
      var result;
      result = bg_app.client.toggle_timer(timer_id);
      return result.success(function(json) {
        return $scope.refresh();
      });
    };
    $scope.delete_timer = function(timer_id) {
      var result;
      result = bg_app.client.delete_entry(timer_id);
      return result.complete(function() {
        return $scope.refresh();
      });
    };
    $scope.show_form = function(timer_id) {
      var timer;
      if (timer_id == null) {
        timer_id = 0;
      }
      $scope.active_timer_id = timer_id;
      $scope.reset_form_fields();
      if ($scope.active_timer_id !== 0) {
        timer = _(bg_app.todays_entries).find(function(item) {
          return item.id === $scope.active_timer_id;
        });
        if (timer) {
          $scope.form_task.project = parseInt(timer.project_id, 10);
          $scope.form_task.task = parseInt(timer.task_id, 10);
          $scope.form_task.hours = timer.hours;
          $scope.form_task.notes = timer.notes;
          $scope.project_change();
        }
      }
      return $scope.form_visible = true;
    };
    $scope.hide_form = function() {
      return $scope.form_visible = false;
    };
    return $scope.reset_form_fields = function() {
      return $scope.form_task = {
        project: null,
        task: null,
        hours: null,
        notes: null
      };
    };
  };

  clock_time_filter = function() {
    return function(input) {
      return input.toClockTime();
    };
  };

  app.controller('TasksController', ['$scope', tasks_controller]);

  app.filter('clockTime', clock_time_filter);

}).call(this);

/*
//@ sourceMappingURL=tasks_controller.map
*/
